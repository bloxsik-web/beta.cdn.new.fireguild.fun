<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FireGuild</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
body{background:#0f1419;height:100vh;overflow:hidden}

/* AUTH */
.auth{
height:100vh;
display:flex;
align-items:center;
justify-content:center;
background:#0f1419;
padding:16px;
}

.auth-box{
width:100%;
max-width:340px;
background:#17212b;
padding:32px;
border-radius:12px;
box-shadow:0 4px 12px rgba(0,0,0,0.3);
}

.auth-box h2{
color:#fff;
margin-bottom:24px;
text-align:center;
font-size:24px;
}

.auth-box input{
width:100%;
padding:14px;
margin-bottom:12px;
background:#1c2733;
border:none;
border-radius:8px;
color:#fff;
outline:none;
font-size:16px;
}

.auth-box button{
width:100%;
padding:14px;
border:none;
border-radius:8px;
background:#5865f2;
color:#fff;
cursor:pointer;
font-size:16px;
font-weight:500;
transition:background 0.2s;
margin-bottom:8px;
}

.auth-box button:last-child {
margin-bottom: 0;
}

.auth-box button.register {
background:#2b5278;
}

.auth-box button.register:active {
background:#1d3b55;
}

/* APP */
.app{
display:none;
height:100vh;
position:relative;
}

.menu-toggle{
display:none;
position:fixed;
bottom:20px;
left:20px;
width:56px;
height:56px;
border-radius:50%;
background:#5865f2;
color:#fff;
border:none;
font-size:24px;
cursor:pointer;
box-shadow:0 4px 12px rgba(0,0,0,0.3);
z-index:100;
transition:transform 0.2s;
}

.menu-toggle:active{transform:scale(0.95);}

.sidebar{
width:300px;
background:#17212b;
border-right:1px solid #222c36;
display:flex;
flex-direction:column;
transition:transform 0.3s ease;
}

.user{
padding:20px 16px;
display:flex;
align-items:center;
gap:12px;
border-bottom:1px solid #222c36;
position:relative;
}

.avatar{
width:48px;
height:48px;
border-radius:50%;
background:#5865f2;
display:flex;
align-items:center;
justify-content:center;
color:#fff;
font-weight:600;
font-size:20px;
transition:background 0.3s;
flex-shrink:0;
}

.user-info{
overflow:hidden;
flex:1;
}

.user-info span{
color:#fff;
font-weight:500;
font-size:16px;
display:block;
white-space:nowrap;
overflow:hidden;
text-overflow:ellipsis;
}

.logout-btn{
background:#d32f2f;
color:white;
border:none;
padding:6px 12px;
border-radius:6px;
cursor:pointer;
font-size:12px;
transition:background 0.2s;
margin-left:auto;
}

.logout-btn:active {
background:#b71c1c;
}

.chat-list{
flex:1;
overflow-y:auto;
-webkit-overflow-scrolling:touch;
}

.chat-item{
padding:16px;
cursor:pointer;
transition:background 0.15s;
border-bottom:1px solid #1f2a35;
}

.chat-item:active{background:#1f2a35;}
.chat-item.active{background:#2b3945;}
.chat-item span{color:#fff;font-weight:500;font-size:15px;}
.chat-item p{color:#8b98a5;font-size:13px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* CHAT AREA */
.chat{
flex:1;
display:flex;
flex-direction:column;
background:#0f1419;
}

.chat-header{
padding:16px 20px;
background:#17212b;
border-bottom:1px solid #222c36;
color:#fff;
font-weight:500;
font-size:16px;
display:flex;
align-items:center;
gap:12px;
}

.back-btn{
display:none;
background:none;
border:none;
color:#fff;
font-size:20px;
cursor:pointer;
padding:0 8px;
}

.messages{
flex:1;
overflow-y:auto;
padding:16px;
display:flex;
flex-direction:column;
gap:12px;
-webkit-overflow-scrolling:touch;
}

.msg{
max-width:85%;
padding:12px 16px;
border-radius:18px;
font-size:15px;
animation:fade 0.15s ease;
word-break:break-word;
}

.mine{
align-self:flex-end;
background:#2b5278;
color:#fff;
border-bottom-right-radius:4px;
}

.other{
align-self:flex-start;
background:#1c2733;
color:#fff;
border-bottom-left-radius:4px;
}

.time{
font-size:11px;
opacity:.6;
margin-top:6px;
text-align:right;
white-space:nowrap;
}

.input{
padding:12px 16px;
background:#17212b;
display:flex;
gap:8px;
border-top:1px solid #222c36;
}

.input input{
flex:1;
padding:12px 16px;
border-radius:24px;
border:none;
background:#1c2733;
color:#fff;
outline:none;
font-size:15px;
}

.input button{
width:44px;
height:44px;
border-radius:50%;
border:none;
background:#5865f2;
color:#fff;
cursor:pointer;
font-size:18px;
transition:background 0.2s;
flex-shrink:0;
}

.input button:active{background:#4752c4;}
.input button:disabled{background:#404e6b; cursor:not-allowed;}

/* Mobile styles */
@media (max-width: 768px) {
.menu-toggle{display:block;}
.back-btn{display:block;}
.sidebar{
position:fixed;
left:0;
top:0;
bottom:0;
z-index:90;
transform:translateX(-100%);
}
.sidebar.active{transform:translateX(0);}
.chat-header{padding-left:12px;}
.msg{max-width:90%;}
}

/* Small phones */
@media (max-width: 480px) {
.auth-box{padding:24px;}
.user{padding:16px;}
.chat-item{padding:14px;}
.msg{font-size:14px;padding:10px 14px;}
.input{padding:10px 12px;}
.input input{padding:10px 14px;}
}

@keyframes fade{
from{opacity:0;transform:translateY(4px)}
to{opacity:1;transform:translateY(0)}
}
</style>
</head>

<body>

<div class="auth" id="auth">
<div class="auth-box">
<h2>üî• FireGuild</h2>
<input id="loginUser" placeholder="Username" autocomplete="username">
<input id="loginPass" type="password" placeholder="Password" autocomplete="current-password">
<button id="loginBtn">–í–æ–π—Ç–∏</button>
<button id="registerBtn" class="register">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
</div>
</div>

<div class="app" id="app">
<button class="menu-toggle" id="menuToggle">‚ò∞</button>

<div class="sidebar" id="sidebar">
<div class="user">
<div class="avatar" id="myAvatar">?</div>
<div class="user-info">
<span id="myName"></span>
</div>
<button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
</div>
<div class="chat-list" id="chatList"></div>
</div>

<div class="chat">
<div class="chat-header">
<button class="back-btn" id="backBtn">‚Üê</button>
<span id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</span>
</div>
<div class="messages" id="messages"></div>
<div class="input" id="chatInput" style="display:none">
<input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
<button id="sendBtn">‚û§</button>
</div>
</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, get, set, push, onChildAdded, onValue, off, query, limitToLast } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDxTZxpBF6ma0m3FLbxQhxD_xngu0Nm6OU",
  authDomain: "fireguildnew-3356a.firebaseapp.com",
  databaseURL: "https://fireguildnew-3356a-default-rtdb.firebaseio.com",
  projectId: "fireguildnew-3356a",
  storageBucket: "fireguildnew-3356a.firebasestorage.app",
  messagingSenderId: "1020153656700",
  appId: "1:1020153656700:web:9a39087a47b8c4138aa0f9"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentUser = null;
let currentChat = null;
let messagesListener = null;
let currentMessagesRef = null;
let chatListUnsubscribe = null;
let isSending = false;
let processedMessageIds = new Set();
let isLoadingMessages = false; // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
let lastMessageTimestamp = 0; // –î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–µ–π

// DOM elements
const auth = document.getElementById('auth');
const appDiv = document.getElementById('app');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const logoutBtn = document.getElementById('logoutBtn');
const loginUser = document.getElementById('loginUser');
const loginPass = document.getElementById('loginPass');
const myName = document.getElementById('myName');
const myAvatar = document.getElementById('myAvatar');
const chatList = document.getElementById('chatList');
const chatTitle = document.getElementById('chatTitle');
const messages = document.getElementById('messages');
const chatInput = document.getElementById('chatInput');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const menuToggle = document.getElementById('menuToggle');
const sidebar = document.getElementById('sidebar');
const backBtn = document.getElementById('backBtn');

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cookie –Ω–∞ 30 –¥–Ω–µ–π
function setCookie(name, value, days) {
  const date = new Date();
  date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
  const expires = "; expires=" + date.toUTCString();
  document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è cookie
function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for(let i = 0; i < ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
  }
  return null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è cookie
function deleteCookie(name) {
  document.cookie = name + '=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC; SameSite=Lax';
}

// Mobile menu handlers
menuToggle.addEventListener('click', () => sidebar.classList.toggle('active'));
backBtn.addEventListener('click', closeChat);

// Close sidebar when clicking outside
document.addEventListener('click', (e) => {
  if(window.innerWidth <= 768 && 
     sidebar.classList.contains('active') && 
     !sidebar.contains(e.target) && 
     !menuToggle.contains(e.target)) {
    sidebar.classList.remove('active');
  }
});

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
registerBtn.onclick = async () => {
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();
  
  if(!u || !p) {
    alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
    return;
  }

  try {
    const userRef = ref(db, `users/${u}`);
    const snap = await get(userRef);
    
    if(snap.exists()) {
      alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
      return;
    }
    
    await set(userRef, {
      password: p,
      created: Date.now()
    });
    
    alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
    
  } catch(e) {
    console.error('Registration error:', e);
    alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + e.message);
  }
};

// –§—É–Ω–∫—Ü–∏—è –≤—Ö–æ–¥–∞
async function login(username, password) {
  if(!username || !password) {
    alert('–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
    return false;
  }

  try {
    console.log('–ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ –∫–∞–∫:', username);
    const userRef = ref(db, `users/${username}`);
    const snap = await get(userRef);
    
    if(!snap.exists()) {
      alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
      return false;
    }
    
    if(snap.val().password !== password) {
      alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
      return false;
    }

    currentUser = {username: username};
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ cookie –Ω–∞ 30 –¥–Ω–µ–π
    setCookie('fireguild_user', username, 30);
    setCookie('fireguild_pass', password, 30);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    auth.style.display = 'none';
    appDiv.style.display = 'flex';
    myName.textContent = username;
    myAvatar.textContent = username.charAt(0).toUpperCase();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã
    loadChats();
    
    return true;
    
  } catch(e) {
    console.error('Login error:', e);
    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + e.message);
    return false;
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞
loginBtn.onclick = () => {
  const u = loginUser.value.trim();
  const p = loginPass.value;
  login(u, p);
};

// –í—ã—Ö–æ–¥
logoutBtn.onclick = () => {
  // –û—á–∏—â–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏
  if(chatListUnsubscribe) {
    chatListUnsubscribe();
    chatListUnsubscribe = null;
  }
  if(currentMessagesRef && messagesListener) {
    off(currentMessagesRef, 'child_added', messagesListener);
    messagesListener = null;
    currentMessagesRef = null;
  }
  
  // –£–¥–∞–ª—è–µ–º cookie
  deleteCookie('fireguild_user');
  deleteCookie('fireguild_pass');
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  currentUser = null;
  currentChat = null;
  processedMessageIds.clear();
  isLoadingMessages = false;
  lastMessageTimestamp = 0;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
  appDiv.style.display = 'none';
  auth.style.display = 'flex';
  
  // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
  messages.innerHTML = '';
  chatList.innerHTML = '';
  chatTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
  chatInput.style.display = 'none';
  loginUser.value = '';
  loginPass.value = '';
};

function loadChats() {
  if(chatListUnsubscribe) {
    chatListUnsubscribe();
  }

  const userChatsRef = ref(db, `users/${currentUser.username}/chats`);
  
  chatListUnsubscribe = onValue(userChatsRef, (snap) => {
    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã —á–∞—Ç—ã:', snap.val());
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
    const currentChatId = currentChat?.id;
    
    chatList.innerHTML = '';
    
    if(!snap.exists()) {
      chatList.innerHTML = '<div style="color:#8b98a5; text-align:center; padding:20px;">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
      return;
    }

    const chats = [];
    snap.forEach(child => {
      chats.push({
        id: child.key,
        ...child.val()
      });
    });

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    chats.sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));

    chats.forEach(chat => {
      const div = document.createElement('div');
      div.className = `chat-item ${currentChatId === chat.id ? 'active' : ''}`;
      div.innerHTML = `
        <span>${chat.with || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'}</span>
        <p>${chat.lastMessage || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</p>
      `;
      div.onclick = () => {
        openChat(chat.id, chat.with || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫');
        if(window.innerWidth <= 768) {
          sidebar.classList.remove('active');
        }
      };
      chatList.appendChild(div);
    });
  }, (error) => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
    chatList.innerHTML = '<div style="color:#ff6b6b; text-align:center; padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤</div>';
  });
}

function openChat(chatId, friend) {
  console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç:', chatId, friend);
  
  // –ï—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç —ç—Ç–æ—Ç –∂–µ —á–∞—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  if(currentChat?.id === chatId) {
    return;
  }
  
  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–ª—É—à–∞—Ç–µ–ª—å
  if(currentMessagesRef && messagesListener) {
    off(currentMessagesRef, 'child_added', messagesListener);
    messagesListener = null;
    currentMessagesRef = null;
  }
  
  // –û—á–∏—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  processedMessageIds.clear();
  isLoadingMessages = true;
  lastMessageTimestamp = 0;

  currentChat = {id: chatId, friend};
  chatTitle.textContent = friend;
  chatInput.style.display = 'flex';
  messages.innerHTML = '<div style="color:#8b98a5; text-align:center; padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  const messagesRef = ref(db, `chats/${chatId}/messages`);
  const messagesQuery = query(messagesRef, limitToLast(50));
  
  get(messagesQuery).then((snap) => {
    messages.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
    
    if(snap.exists()) {
      const messages_array = [];
      snap.forEach(child => {
        messages_array.push({
          id: child.key,
          ...child.val()
        });
      });
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
      messages_array.sort((a, b) => a.timestamp - b.timestamp);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      messages_array.forEach(msg => {
        processedMessageIds.add(msg.id);
        if (msg.timestamp > lastMessageTimestamp) {
          lastMessageTimestamp = msg.timestamp;
        }
        addMessageToChat(msg);
      });
      
      messages.scrollTop = messages.scrollHeight;
    }
    
    isLoadingMessages = false;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º query —Å limitToLast(1) —á—Ç–æ–±—ã –ø–æ–ª—É—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ
    const newMessagesQuery = query(messagesRef, limitToLast(1));
    
    currentMessagesRef = newMessagesQuery;
    
    messagesListener = onChildAdded(newMessagesQuery, (snap) => {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
      if (isLoadingMessages) return;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ —É–∂–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ
      if (!processedMessageIds.has(snap.key)) {
        const msg = snap.val();
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–µ–π
        if (msg.timestamp > lastMessageTimestamp) {
          console.log('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', snap.key, msg);
          processedMessageIds.add(snap.key);
          lastMessageTimestamp = msg.timestamp;
          addMessageToChat(msg);
          messages.scrollTop = messages.scrollHeight;
        }
      }
    });
    
  }).catch(error => {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    messages.innerHTML = '<div style="color:#ff6b6b; text-align:center; padding:20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    isLoadingMessages = false;
  });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
function addMessageToChat(msg) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ DOM
  const existingMessages = messages.querySelectorAll('.msg');
  for (let existingMsg of existingMessages) {
    const timeDiv = existingMsg.querySelector('.time');
    if (timeDiv && timeDiv.textContent.includes(new Date(msg.timestamp).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'}))) {
      const msgText = existingMsg.childNodes[0]?.nodeValue?.trim();
      if (msgText === msg.text) {
        console.log('–°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å –≤ DOM, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
        return;
      }
    }
  }
  
  const mine = msg.sender === currentUser.username;
  
  const div = document.createElement('div');
  div.className = 'msg ' + (mine ? 'mine' : 'other');
  div.setAttribute('data-message-id', msg.id || Date.now() + Math.random()); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
  div.innerHTML = `
    ${escapeHtml(msg.text)}
    <div class="time">
      ${new Date(msg.timestamp).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
    </div>
  `;
  messages.appendChild(div);
}

function closeChat() {
  if(currentMessagesRef && messagesListener) {
    off(currentMessagesRef, 'child_added', messagesListener);
    messagesListener = null;
    currentMessagesRef = null;
  }
  currentChat = null;
  processedMessageIds.clear();
  isLoadingMessages = false;
  lastMessageTimestamp = 0;
  chatTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
  chatInput.style.display = 'none';
  messages.innerHTML = '';
  
  if(window.innerWidth <= 768) {
    sidebar.classList.add('active');
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

sendBtn.onclick = sendMessage;
msgInput.onkeypress = e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };

async function sendMessage() {
  const text = msgInput.value.trim();
  if(!text || !currentChat || isSending) return;

  // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
  isSending = true;
  sendBtn.disabled = true;

  const message = {
    text,
    sender: currentUser.username,
    timestamp: Date.now()
  };

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
  const originalText = text;
  msgInput.value = '';

  try {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ –∫–ª—é—á
    const newMessageRef = await push(ref(db, `chats/${currentChat.id}/messages`), message);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –≤ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    processedMessageIds.add(newMessageRef.key);
    if (message.timestamp > lastMessageTimestamp) {
      lastMessageTimestamp = message.timestamp;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
    await set(ref(db, `users/${currentUser.username}/chats/${currentChat.id}/lastMessage`), text);
    await set(ref(db, `users/${currentUser.username}/chats/${currentChat.id}/lastMessageTime`), Date.now());
    
  } catch(e) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', e);
    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
    msgInput.value = originalText;
  } finally {
    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É
    isSending = false;
    sendBtn.disabled = false;
  }
}

// –ê–≤—Ç–æ–≤—Ö–æ–¥ –∏–∑ cookie (30 –¥–Ω–µ–π)
async function autoLogin() {
  const savedUser = getCookie('fireguild_user');
  const savedPass = getCookie('fireguild_pass');
  
  if(savedUser && savedPass) {
    console.log('–ü—Ä–æ–±—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –¥–ª—è:', savedUser);
    loginUser.value = savedUser;
    loginPass.value = savedPass;
    await login(savedUser, savedPass);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–≤—Ö–æ–¥ –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
setTimeout(autoLogin, 1000);

</script>
</body>
</html>